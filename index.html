<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shop Floor Map</title>
<style>
  :root { --markerSize: 28px; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b0e13; color:#e9eef6; }

  /* Header */
  header { display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:12px 14px; background:#111623; border-bottom:1px solid #1d2533; position:sticky; top:0; z-index:20; }
  .brand { font-weight:700; }
  .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .muted { color:#9db0cc; font-size:12px; }
  select, button { background:#0b1220; color:#e9eef6; border:1px solid #2e3b57; border-radius:8px; padding:8px 10px; }
  button { background:#1e2a44; }
  button:hover { background:#263352; }
  label input[type="checkbox"] { transform: translateY(1px); }

  /* Layout */
  .wrap { display:grid; grid-template-columns: 1fr; }
  .canvas {
    position:relative; height: calc(100vh - 64px);
    background:#0f1626; border-bottom:1px solid #28324a; overflow:hidden;
    background-size: contain; background-repeat:no-repeat; background-position: center;
  }
  .gridBG {
    position:absolute; inset:0; pointer-events:none;
    background-image:linear-gradient(#182038 1px, transparent 1px), linear-gradient(90deg, #182038 1px, transparent 1px);
    background-size:24px 24px; opacity:.35;
  }

  /* Marker */
  .marker { position:absolute; width:var(--markerSize); height:var(--markerSize); border-radius:50%;
    border:2px solid #0b0e13; transform:translate(-50%, -50%);
    cursor:grab; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:800;
    color:#0b0e13; box-shadow:0 2px 10px rgba(0,0,0,.35); }
  .marker.dragging { cursor:grabbing; opacity:.9; }
  .marker .hint { position:absolute; top:30px; left:50%; transform:translateX(-50%);
    background:#0b1220; border:1px solid #263352; padding:2px 6px; border-radius:6px; font-size:10px; white-space:nowrap; display:none; color:#a9b7d9; }
  .marker.showHint .hint { display:block; }

  /* Side panel (collapsible) */
  .panel {
    position: fixed; right: 10px; top: 74px; bottom: 10px; width: 360px;
    background:#0f1626; border:1px solid #28324a; border-radius:12px; padding:12px; z-index:25;
    box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:auto; transform: translateX(400px); transition: transform .25s ease;
  }
  .panel.open { transform: translateX(0); }
  .panel h3 { margin:0 0 8px 0; }
  .list { display:flex; flex-direction:column; gap:8px; }
  .card { background:#0b1220; border:1px solid #222c43; border-radius:10px; padding:10px;
          display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; }
  .pill { padding:2px 8px; border-radius:999px; border:1px solid #2e3b57; background:#121a2e; font-size:11px; }
  .small { color:#a9b7d9; font-size:12px; }
  a { color:#6ee7ff; text-decoration:none; }
  a:hover { text-decoration:underline; }

  /* FAB toggle for panel */
  .fab {
    position: fixed; right: 12px; bottom: 14px; z-index: 26;
    background:#1e2a44; border:1px solid #2e3b57; color:#e9eef6; border-radius:999px; padding:12px 14px;
    box-shadow:0 8px 20px rgba(0,0,0,.4);
  }

  /* Bay picker modal */
  .modal {
    position: fixed; inset:0; background: rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:30;
  }
  .dialog {
    width: min(92vw, 460px); background:#0f1626; border:1px solid #28324a; border-radius:12px; padding:16px;
  }
  .dialog h2 { margin:0 0 8px 0; }
  .bayBtns { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
  .bayBtns button { flex: 1 1 100px; }

  @media (min-width: 1100px) {
    .wrap { grid-template-columns: 1fr 380px; }
    .panel { position: static; transform:none; height: calc(100vh - 64px); box-shadow:none; border-left:1px solid #28324a; }
    .fab { display:none; }
  }
</style>
</head>
<body>
<header>
  <div class="row">
    <div class="brand">Shop Floor Map</div>
    <label class="row"><input type="checkbox" id="editToggle"> <span>Edit Mode</span></label>
  </div>
  <div class="row">
    <label class="muted">Bay:</label>
    <select id="baySelect" title="Select Bay">
      <option value="A">Bay A</option>
      <option value="B">Bay B</option>
      <option value="C">Bay C</option>
    </select>
    <button id="addMarkerBtn">Add Whiteboard</button>
  </div>
</header>

<div class="wrap">
  <div id="canvas" class="canvas">
    <div class="gridBG"></div>
    <!-- markers injected here -->
  </div>

  <!-- Side panel (starts closed on mobile) -->
  <aside id="panel" class="panel">
    <h3>Whiteboards</h3>
    <div id="list" class="list"></div>
  </aside>
</div>

<button id="fab" class="fab">Open Panel</button>

<!-- Bay picker (first visit) -->
<div id="bayModal" class="modal" style="display:none;">
  <div class="dialog">
    <h2>Select a Bay</h2>
    <div class="muted">Choose the bay to view. You can change it later from the header.</div>
    <div class="bayBtns">
      <button data-bay="A">Bay A</button>
      <button data-bay="B">Bay B</button>
      <button data-bay="C">Bay C</button>
    </div>
  </div>
</div>

<script>
/* ===== Config: set your background images here ===== */
const bayBackgrounds = {
  A: 'assets/factory-layout.png', // your PNG path
  B: 'assets/factory-layout.png',
  C: 'assets/factory-layout.png'
};

/* ===== Local store (we'll swap this to Firebase later) ===== */
const STORAGE_KEY = 'shopFloor.v2'; // bump key so old localStorage doesn't conflict
function defaultState(){
  return {
    activeBay: null, // force picker first time
    edit: false,
    boards: {
      'WB-A-01': { id:'WB-A-01', label:'WB A-01', bay:'A', x:20, y:30, stage:'Prep' },
      'WB-B-02': { id:'WB-B-02', label:'WB B-02', bay:'B', x:60, y:50, stage:'Assembly' },
      'WB-C-03': { id:'WB-C-03', label:'WB C-03', bay:'C', x:40, y:70, stage:'Test' },
    }
  };
}
function loadState(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultState(); }catch{ return defaultState(); } }
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
let state = loadState();

/* ===== Helpers ===== */
const byId = id => document.getElementById(id);
const canvas = byId('canvas');
const listEl = byId('list');
const panel = byId('panel');
const fab = byId('fab');
const baySelect = byId('baySelect');
const editToggle = byId('editToggle');
const bayModal = byId('bayModal');

function stageColor(s){
  switch(s){
    case 'Prep': return '#3b82f6';
    case 'Assembly': return '#22c55e';
    case 'Test': return '#facc15';
    case 'Rework': return '#ef4444';
    default: return '#6ee7ff';
  }
}

/* ===== Render ===== */
function renderCanvasBG(){
  const bay = state.activeBay || 'A';
  const url = bayBackgrounds[bay] || '';
  canvas.style.backgroundImage = url ? `url('${url}')` : '';
}

function clearMarkers(){ canvas.querySelectorAll('.marker').forEach(m=>m.remove()); }

function markerEl(board){
  const m = document.createElement('div');
  m.className = 'marker';
  m.style.left = board.x + '%';
  m.style.top = board.y + '%';
  m.style.background = stageColor(board.stage);
  m.dataset.id = board.id;
  m.title = `${board.label} â€” ${board.stage}`;
  m.innerHTML = `<span>${board.label.split(' ').pop()}</span><div class="hint">Drag to move</div>`;
  if (state.edit) m.classList.add('showHint');

  // drag
  m.addEventListener('pointerdown', (e)=>{
    if (!state.edit) return;
    m.setPointerCapture(e.pointerId);
    m.classList.add('dragging');
    const rect = canvas.getBoundingClientRect();
    const onMove = (ev)=>{
      const rx = ((ev.clientX - rect.left) / rect.width) * 100;
      const ry = ((ev.clientY - rect.top) / rect.height) * 100;
      const nx = Math.max(1.5, Math.min(98.5, rx));
      const ny = Math.max(3, Math.min(97, ry));
      m.style.left = nx + '%'; m.style.top = ny + '%';
    };
    const onUp = ()=>{
      m.releasePointerCapture(e.pointerId);
      m.classList.remove('dragging');
      const id = m.dataset.id;
      state.boards[id].x = parseFloat(m.style.left);
      state.boards[id].y = parseFloat(m.style.top);
      saveState();
      window.removeEventListener('pointermove', onMove);
      window.removeEventListener('pointerup', onUp);
    };
    window.addEventListener('pointermove', onMove);
    window.addEventListener('pointerup', onUp);
  });

  // click opens board page (disabled in edit)
  m.addEventListener('click', ()=>{
    if (state.edit) return;
    location.href = `board.html?board=${encodeURIComponent(board.id)}`;
  });

  return m;
}

function renderMarkers(){
  clearMarkers();
  const active = state.activeBay || 'A';
  Object.values(state.boards).forEach(b=>{
    if (b.bay !== active) return; // show only current bay
    canvas.appendChild(markerEl(b));
  });
}

function renderList(){
  listEl.innerHTML = '';
  const active = state.activeBay || 'A';
  const boards = Object.values(state.boards)
    .filter(b=>b.bay === active)
    .sort((a,b)=> a.id.localeCompare(b.id));
  boards.forEach(b=>{
    const card = document.createElement('div'); card.className='card';
    const left = document.createElement('div');
    left.innerHTML = `
      <div class="row">
        <strong>${b.label}</strong>
        <span class="pill">Bay ${b.bay}</span>
        <span class="pill">${b.stage}</span>
      </div>
      <div class="small">QR path: <code>/board.html?board=${b.id}</code></div>
    `;
    const right = document.createElement('div'); right.className='row';

    // stage select
    const sel = document.createElement('select');
    ['Prep','Assembly','Test','Rework'].forEach(st=>{
      const opt = document.createElement('option');
      opt.value = st; opt.textContent = st; if (b.stage===st) opt.selected = true;
      sel.appendChild(opt);
    });
    sel.addEventListener('change', ()=>{
      state.boards[b.id].stage = sel.value; saveState(); renderMarkers(); renderList();
    });

    const open = document.createElement('a'); open.href = `board.html?board=${encodeURIComponent(b.id)}`; open.textContent = 'Open';
    right.appendChild(sel); right.appendChild(open);

    card.appendChild(left); card.appendChild(right);
    listEl.appendChild(card);
  });
}

function renderAll(){
  renderCanvasBG();
  renderMarkers();
  renderList();
}

/* ===== Controls ===== */
editToggle.checked = !!state.edit;
editToggle.addEventListener('change', ()=>{
  state.edit = editToggle.checked; saveState(); renderAll();
});

byId('addMarkerBtn').addEventListener('click', ()=>{
  const next = prompt('New whiteboard ID (e.g., WB-A-04):'); if (!next) return;
  if (state.boards[next]) { alert('ID already exists.'); return; }
  const bay = (prompt('Bay (A/B/C):', state.activeBay || 'A') || 'A').toUpperCase();
  if (!['A','B','C'].includes(bay)) { alert('Invalid bay'); return; }
  const label = prompt('Label (e.g., WB A-04):', next.replaceAll('-', ' ')) || next;
  const stage = (prompt('Stage (Prep/Assembly/Test/Rework):','Prep') || 'Prep');
  state.boards[next] = { id: next, label, bay, x: 50, y: 50, stage };
  saveState(); renderAll();
});

/* Bay dropdown */
baySelect.value = state.activeBay || 'A';
baySelect.addEventListener('change', ()=>{
  state.activeBay = baySelect.value; saveState(); renderAll();
});

/* Panel toggle (mobile) */
function openPanel(){ panel.classList.add('open'); fab.textContent='Close Panel'; }
function closePanel(){ panel.classList.remove('open'); fab.textContent='Open Panel'; }
fab.addEventListener('click', ()=>{
  if (panel.classList.contains('open')) closePanel(); else openPanel();
});
/* start closed on mobile; open by default on wide screens via CSS */

/* First-visit bay picker */
function showBayPicker(){
  bayModal.style.display = 'flex';
  bayModal.querySelectorAll('button[data-bay]').forEach(btn=>{
    btn.onclick = ()=>{
      const bay = btn.getAttribute('data-bay');
      state.activeBay = bay; saveState();
      baySelect.value = bay;
      bayModal.style.display = 'none';
      renderAll();
    };
  });
}

if (!state.activeBay) {
  showBayPicker();
}

/* Init */
renderAll();
</script>
</body>
</html>